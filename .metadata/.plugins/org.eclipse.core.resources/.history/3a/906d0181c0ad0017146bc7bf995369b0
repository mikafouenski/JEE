package jdbc;

import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.Collection;

import exception.DaoException;
import person.Person;


public class Dao extends JdbcTools{
	
	public Collection<Person> findPersons() throws DaoException {
		ResultSetToBean<Person> t = (rs)-> { Person a = new Person(rs.getString("nom"), rs.getString("prenom"), rs.getInt("age")); a.setId(rs.getInt("id")); return a};
		String query = "select nom, prenom, age from personnes;";
		Collection<Person> persons = null;
		try {
			persons = findBeans(query,t);
		} catch (SQLException e) {
			throw new DaoException();
		}
		return persons; 
	}
	
//	public void addPerson(Person p) throws DaoException {
//		try (Connection c = newConnection()) {
//			Statement st = c.createStatement();
//			String sql  = "INSERT INTO personnes(nom,prenom,age) VALUES ("
//					+"'" + p.getNom() + "', "
//					+"'" + p.getPrenom() + "', "
//					+ p.getAge() + ");";
//			st.executeUpdate(sql);
//			st.close();
//		} catch (SQLException e) {
//			throw new DaoException(); 
//		} 
//	}
	
	public void addPerson(Person p) throws DaoException {
		try (Connection c = newConnection();
			 Statement st = c.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE,
			 ResultSet.CONCUR_UPDATABLE);
			 ResultSet rs = st.executeQuery("Select* From personnes;")
			) {
			
			rs.moveToInsertRow();
			rs.updateString("nom", p.getNom());
			rs.updateString("prenom", p.getPrenom());
			rs.updateInt("age", p.getAge());
			rs.insertRow();
			
		} catch (SQLException e) {
			throw new DaoException(); 
		} 
	}
	
	public void removePerson(int id) throws DaoException {
		try (Connection c = newConnection();
			 Statement st = c.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE,
			 ResultSet.CONCUR_UPDATABLE);
			 ResultSet rs = st.executeQuery("Select* From personnes Where id =" + id +";");
			) {
			rs.absolute(1);
			rs.deleteRow();
		} catch (SQLException e) {
			e.printStackTrace();
			throw new DaoException(); 
		} 
	}
	
	public void UpdatePerson(Person p) throws DaoException {
		try (Connection c = newConnection();
			 Statement st = c.createStatement(ResultSet.TYPE_SCROLL_INSENSITIVE,
			 ResultSet.CONCUR_UPDATABLE);
			 ResultSet rs = st.executeQuery("Select* From personnes Where id =" + p.getId() +";");
			) {
			rs.first();
			rs.updateString("nom", p.getNom());
			rs.updateString("prenom", p.getPrenom());
			rs.updateInt("age", p.getAge());
			rs.updateRow();
			
		} catch (SQLException e) {
			e.printStackTrace();
			throw new DaoException(); 
		} 
	}

}
